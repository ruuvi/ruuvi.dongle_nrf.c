
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_uart.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @addtogroup APP_UART</a>
<a name="ln3"> * @{</a>
<a name="ln4"> */</a>
<a name="ln5">/**</a>
<a name="ln6"> *  @file app_uart.c</a>
<a name="ln7"> *  @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln8"> *  @date 2020-05-29</a>
<a name="ln9"> *  @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln10"> *</a>
<a name="ln11"> *  Application UART control, processing incoming data and sending data out.</a>
<a name="ln12"> */</a>
<a name="ln13">#include &quot;app_config.h&quot;</a>
<a name="ln14">#include &quot;app_uart.h&quot;</a>
<a name="ln15">#include &quot;app_ble.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_boards.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln18">#include &quot;ruuvi_endpoint_ca_uart.h&quot;</a>
<a name="ln19">#include &quot;ruuvi_interface_communication.h&quot;</a>
<a name="ln20">#include &quot;ruuvi_interface_communication_radio.h&quot;</a>
<a name="ln21">#include &quot;ruuvi_interface_communication_ble_advertising.h&quot;</a>
<a name="ln22">#include &quot;ruuvi_interface_watchdog.h&quot;</a>
<a name="ln23">#include &quot;ruuvi_interface_scheduler.h&quot;</a>
<a name="ln24">#include &quot;ruuvi_interface_communication_uart.h&quot;</a>
<a name="ln25">#include &quot;ruuvi_library_ringbuffer.h&quot;</a>
<a name="ln26">#include &quot;ruuvi_interface_yield.h&quot;</a>
<a name="ln27"> </a>
<a name="ln28">#include &lt;string.h&gt;</a>
<a name="ln29"> </a>
<a name="ln30">#define APP_UART_RING_BUFFER_MAX_LEN     (128U) //!&lt; Ring buffer len       </a>
<a name="ln31">#define APP_UART_RING_DEQ_BUFFER_MAX_LEN (APP_UART_RING_BUFFER_MAX_LEN &gt;&gt;1) //!&lt; Decode buffer len</a>
<a name="ln32"> </a>
<a name="ln33">#ifndef CEEDLING</a>
<a name="ln34">static bool app_uart_ringbuffer_lock_dummy (volatile uint32_t * const flag, bool lock);</a>
<a name="ln35">#endif</a>
<a name="ln36"> </a>
<a name="ln37">static ri_comm_channel_t m_uart; //!&lt; UART communication interface.</a>
<a name="ln38">static uint8_t buffer_data[APP_UART_RING_BUFFER_MAX_LEN] = {0};</a>
<a name="ln39">static bool buffer_wlock = false;</a>
<a name="ln40">static bool buffer_rlock = false;</a>
<a name="ln41"> </a>
<a name="ln42">#ifndef CEEDLING</a>
<a name="ln43">static</a>
<a name="ln44">#endif</a>
<a name="ln45">volatile bool m_uart_ack = false;</a>
<a name="ln46"> </a>
<a name="ln47">static rl_ringbuffer_t m_uart_ring_buffer =</a>
<a name="ln48">{</a>
<a name="ln49">    .head = 0,</a>
<a name="ln50">    .tail = 0,</a>
<a name="ln51">    .block_size = sizeof (uint8_t),</a>
<a name="ln52">    .storage_size = sizeof (buffer_data),</a>
<a name="ln53">    .index_mask = (sizeof (buffer_data) / sizeof (uint8_t)) - 1,</a>
<a name="ln54">    .storage = buffer_data,</a>
<a name="ln55">    .lock = app_uart_ringbuffer_lock_dummy,</a>
<a name="ln56">    .writelock = &amp;buffer_wlock,</a>
<a name="ln57">    .readlock  = &amp;buffer_rlock</a>
<a name="ln58">};</a>
<a name="ln59"> </a>
<a name="ln60">/** Dummy function to lock/unlock buffer */</a>
<a name="ln61">#ifndef CEEDLING</a>
<a name="ln62">static</a>
<a name="ln63">#endif</a>
<a name="ln64">bool app_uart_ringbuffer_lock_dummy (volatile uint32_t * const flag, bool lock)</a>
<a name="ln65">{</a>
<a name="ln66">    bool * p_bool = (bool *) flag;</a>
<a name="ln67"> </a>
<a name="ln68">    if (*p_bool == lock) { return false; }</a>
<a name="ln69"> </a>
<a name="ln70">    *p_bool = lock;</a>
<a name="ln71">    return true;</a>
<a name="ln72">}</a>
<a name="ln73"> </a>
<a name="ln74">#ifndef CEEDLING</a>
<a name="ln75">static</a>
<a name="ln76">rd_status_t app_uart_apply_config (re_ca_uart_payload_t * p_uart_payload)</a>
<a name="ln77">#else</a>
<a name="ln78">rd_status_t app_uart_apply_config (void * v_uart_payload)</a>
<a name="ln79">#endif</a>
<a name="ln80">{</a>
<a name="ln81">#ifdef CEEDLING</a>
<a name="ln82">    re_ca_uart_payload_t * p_uart_payload = (re_ca_uart_payload_t *) v_uart_payload;</a>
<a name="ln83">#endif</a>
<a name="ln84">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln85">    ri_radio_modulation_t modulation;</a>
<a name="ln86">    ri_radio_channels_t channels;</a>
<a name="ln87"> </a>
<a name="ln88">    switch (p_uart_payload-&gt;cmd)</a>
<a name="ln89">    {</a>
<a name="ln90">        case RE_CA_UART_SET_FLTR_TAGS:</a>
<a name="ln91">            err_code |= app_ble_manufacturer_filter_set ((bool)</a>
<a name="ln92">                        p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln93">            break;</a>
<a name="ln94"> </a>
<a name="ln95">        case RE_CA_UART_SET_FLTR_ID:</a>
<a name="ln96">            err_code |= app_ble_manufacturer_id_set (p_uart_payload-&gt;params.fltr_id_param.id);</a>
<a name="ln97">            break;</a>
<a name="ln98"> </a>
<a name="ln99">        case RE_CA_UART_SET_CODED_PHY:</a>
<a name="ln100">            modulation = RI_RADIO_BLE_125KBPS;</a>
<a name="ln101">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln102">                                                   (bool) p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln103">            break;</a>
<a name="ln104"> </a>
<a name="ln105">        case RE_CA_UART_SET_SCAN_1MB_PHY:</a>
<a name="ln106">            modulation = RI_RADIO_BLE_1MBPS;</a>
<a name="ln107">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln108">                                                   (bool) p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln109">            break;</a>
<a name="ln110"> </a>
<a name="ln111">        case RE_CA_UART_SET_EXT_PAYLOAD:</a>
<a name="ln112">            modulation = RI_RADIO_BLE_2MBPS;</a>
<a name="ln113">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln114">                                                   (bool) p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln115">            break;</a>
<a name="ln116"> </a>
<a name="ln117">        case RE_CA_UART_SET_CH_37:</a>
<a name="ln118">            err_code |= app_ble_channels_get (&amp;channels);</a>
<a name="ln119">            channels.channel_37 = p_uart_payload-&gt;params.bool_param.state;</a>
<a name="ln120">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln121">            break;</a>
<a name="ln122"> </a>
<a name="ln123">        case RE_CA_UART_SET_CH_38:</a>
<a name="ln124">            err_code |= app_ble_channels_get (&amp;channels);</a>
<a name="ln125">            channels.channel_38 = p_uart_payload-&gt;params.bool_param.state;</a>
<a name="ln126">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln127">            break;</a>
<a name="ln128"> </a>
<a name="ln129">        case RE_CA_UART_SET_CH_39:</a>
<a name="ln130">            err_code |= app_ble_channels_get (&amp;channels);</a>
<a name="ln131">            channels.channel_39 = p_uart_payload-&gt;params.bool_param.state;</a>
<a name="ln132">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln133">            break;</a>
<a name="ln134"> </a>
<a name="ln135">        case RE_CA_UART_SET_ALL:</a>
<a name="ln136">            err_code |= app_ble_manufacturer_id_set (p_uart_payload-&gt;params.all_params.fltr_id.id);</a>
<a name="ln137">            err_code |= app_ble_manufacturer_filter_set ((bool)</a>
<a name="ln138">                        p_uart_payload-&gt;params.all_params.bools.fltr_tags.state);</a>
<a name="ln139">            channels.channel_37 = p_uart_payload-&gt;params.all_params.bools.ch_37.state;</a>
<a name="ln140">            channels.channel_38 = p_uart_payload-&gt;params.all_params.bools.ch_38.state;</a>
<a name="ln141">            channels.channel_39 = p_uart_payload-&gt;params.all_params.bools.ch_39.state;</a>
<a name="ln142">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln143">            modulation = RI_RADIO_BLE_125KBPS;</a>
<a name="ln144">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln145">                                                   (bool) p_uart_payload-&gt;params.all_params.bools.coded_phy.state);</a>
<a name="ln146">            modulation = RI_RADIO_BLE_1MBPS;</a>
<a name="ln147">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln148">                                                   (bool) p_uart_payload-&gt;params.all_params.bools.scan_phy.state);</a>
<a name="ln149">            modulation = RI_RADIO_BLE_2MBPS;</a>
<a name="ln150">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln151">                                                   (bool) p_uart_payload-&gt;params.all_params.bools.ext_payload.state);</a>
<a name="ln152">            break;</a>
<a name="ln153"> </a>
<a name="ln154">        default:</a>
<a name="ln155">            err_code |= RE_ERROR_INVALID_PARAM;</a>
<a name="ln156">            break;</a>
<a name="ln157">    }</a>
<a name="ln158"> </a>
<a name="ln159">    return err_code;</a>
<a name="ln160">}</a>
<a name="ln161">#if 0</a>
<a name="ln162">#ifndef CEEDLING</a>
<a name="ln163">static</a>
<a name="ln164">#endif</a>
<a name="ln165">void app_uart_repeat_send (void * p_data, uint16_t data_len)</a>
<a name="ln166">{</a>
<a name="ln167">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln168">    ri_comm_message_t msg = {0};</a>
<a name="ln169">    msg.repeat_count = 1;</a>
<a name="ln170">    msg.data_length = data_len;</a>
<a name="ln171">    memcpy (msg.data, p_data, data_len);</a>
<a name="ln172">    err_code |= m_uart.send (&amp;msg);</a>
<a name="ln173"> </a>
<a name="ln174">    if (RE_SUCCESS != err_code)</a>
<a name="ln175">    {</a>
<a name="ln176">        err_code |= ri_scheduler_event_put (msg.data, (uint16_t) msg.data_length,</a>
<a name="ln177">                                            app_uart_repeat_send);</a>
<a name="ln178">    }</a>
<a name="ln179"> </a>
<a name="ln180">    if (RD_SUCCESS == err_code)</a>
<a name="ln181">    {</a>
<a name="ln182">        ri_watchdog_feed();</a>
<a name="ln183">    }</a>
<a name="ln184">}</a>
<a name="ln185">#endif</a>
<a name="ln186"> </a>
<a name="ln187">#ifndef CEEDLING</a>
<a name="ln188">static</a>
<a name="ln189">#endif</a>
<a name="ln190">void app_uart_parser (void * p_data, uint16_t data_len)</a>
<a name="ln191">{</a>
<a name="ln192">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln193">    ri_comm_message_t msg = {0};</a>
<a name="ln194">    msg.data_length = sizeof (msg.data);</a>
<a name="ln195">    re_ca_uart_payload_t uart_payload = {0};</a>
<a name="ln196">    uint8_t dequeue_data[APP_UART_RING_DEQ_BUFFER_MAX_LEN] = {0};</a>
<a name="ln197">    rl_status_t status = RL_SUCCESS;</a>
<a name="ln198">    size_t index = 0;</a>
<a name="ln199">    err_code = re_ca_uart_decode ((uint8_t *) p_data, &amp;uart_payload);</a>
<a name="ln200"> </a>
<a name="ln201">    if (RD_SUCCESS == err_code)</a>
<a name="ln202">    {</a>
<a name="ln203">        do</a>
<a name="ln204">        {</a>
<a name="ln205">            uint8_t * p_dequeue_data = NULL;</a>
<a name="ln206">            status = rl_ringbuffer_dequeue (&amp;m_uart_ring_buffer,</a>
<a name="ln207">                                            &amp;p_dequeue_data);</a>
<a name="ln208"> </a>
<a name="ln209">            if (NULL != p_dequeue_data)</a>
<a name="ln210">            {</a>
<a name="ln211">                dequeue_data[index++] = *p_dequeue_data;</a>
<a name="ln212">            }</a>
<a name="ln213">        } while (RL_SUCCESS == status);</a>
<a name="ln214">    }</a>
<a name="ln215">    else</a>
<a name="ln216">    {</a>
<a name="ln217">        do</a>
<a name="ln218">        {</a>
<a name="ln219">            status = rl_ringbuffer_queue (&amp;m_uart_ring_buffer,</a>
<a name="ln220">                                          (void *) ((uint8_t *) p_data + index),</a>
<a name="ln221">                                          sizeof (uint8_t));</a>
<a name="ln222">            index++;</a>
<a name="ln223">        } while ((RL_SUCCESS == status) &amp;&amp; (index &lt; data_len));</a>
<a name="ln224"> </a>
<a name="ln225">        index = 0;</a>
<a name="ln226"> </a>
<a name="ln227">        do</a>
<a name="ln228">        {</a>
<a name="ln229">            uint8_t * p_dequeue_data = NULL;</a>
<a name="ln230">            status = rl_ringbuffer_dequeue (&amp;m_uart_ring_buffer,</a>
<a name="ln231">                                            &amp;p_dequeue_data);</a>
<a name="ln232"> </a>
<a name="ln233">            if (NULL != p_dequeue_data)</a>
<a name="ln234">            {</a>
<a name="ln235">                dequeue_data[index++] = *p_dequeue_data;</a>
<a name="ln236">            }</a>
<a name="ln237">        } while (RL_SUCCESS == status);</a>
<a name="ln238"> </a>
<a name="ln239">        err_code = re_ca_uart_decode ((uint8_t *) dequeue_data, &amp;uart_payload);</a>
<a name="ln240"> </a>
<a name="ln241">        if (RD_SUCCESS != err_code)</a>
<a name="ln242">        {</a>
<a name="ln243">            size_t len = index;</a>
<a name="ln244">            index = 0;</a>
<a name="ln245"> </a>
<a name="ln246">            do</a>
<a name="ln247">            {</a>
<a name="ln248">                status = rl_ringbuffer_queue (&amp;m_uart_ring_buffer, (void *) (dequeue_data + index),</a>
<a name="ln249">                                              sizeof (uint8_t));</a>
<a name="ln250">                index++;</a>
<a name="ln251">            } while ((RL_SUCCESS == status) &amp;&amp; (index &lt; len));</a>
<a name="ln252">        }</a>
<a name="ln253">    }</a>
<a name="ln254"> </a>
<a name="ln255">    if (RD_SUCCESS == err_code)</a>
<a name="ln256">    {</a>
<a name="ln257">        if (RE_CA_UART_GET_DEVICE_ID == uart_payload.cmd)</a>
<a name="ln258">        {</a>
<a name="ln259">            uint64_t mac;</a>
<a name="ln260">            uint64_t id;</a>
<a name="ln261">            err_code |= ri_radio_address_get (&amp;mac);</a>
<a name="ln262">            err_code |= ri_comm_id_get (&amp;id);</a>
<a name="ln263">            uart_payload.cmd = RE_CA_UART_DEVICE_ID;</a>
<a name="ln264">            uart_payload.params.device_id.id = id;</a>
<a name="ln265">            uart_payload.params.device_id.addr = mac;</a>
<a name="ln266">        }</a>
<a name="ln267">        else</a>
<a name="ln268">        {</a>
<a name="ln269">            if (RD_SUCCESS == app_uart_apply_config (&amp;uart_payload))</a>
<a name="ln270">            {</a>
<a name="ln271">                uart_payload.params.ack.ack_state.state = RE_CA_ACK_OK;</a>
<a name="ln272">            }</a>
<a name="ln273">            else</a>
<a name="ln274">            {</a>
<a name="ln275">                uart_payload.params.ack.ack_state.state = RE_CA_ACK_ERROR;</a>
<a name="ln276">            }</a>
<a name="ln277"> </a>
<a name="ln278">            if (RE_CA_UART_SET_ALL == uart_payload.cmd)</a>
<a name="ln279">            {</a>
<a name="ln280">                m_uart_ack = true;</a>
<a name="ln281">                err_code |= app_ble_scan_start(); // Applies new scanning settings.</a>
<a name="ln282">            }</a>
<a name="ln283"> </a>
<a name="ln284">            uart_payload.params.ack.cmd = uart_payload.cmd;</a>
<a name="ln285">            uart_payload.cmd = RE_CA_UART_ACK;</a>
<a name="ln286">        }</a>
<a name="ln287"> </a>
<a name="ln288">        err_code |= re_ca_uart_encode (msg.data, &amp;msg.data_length, &amp;uart_payload);</a>
<a name="ln289">        msg.repeat_count = 1;</a>
<a name="ln290"> </a>
<a name="ln291">        if (RE_SUCCESS == err_code)</a>
<a name="ln292">        {</a>
<a name="ln293">            err_code |= m_uart.send (&amp;msg);</a>
<a name="ln294">#if 0</a>
<a name="ln295"> </a>
<a name="ln296">            if (RE_SUCCESS != err_code)</a>
<a name="ln297">            {</a>
<a name="ln298">                err_code |= ri_scheduler_event_put (msg.data, (uint16_t) msg.data_length,</a>
<a name="ln299">                                                    app_uart_repeat_send);</a>
<a name="ln300">            }</a>
<a name="ln301"> </a>
<a name="ln302">#endif</a>
<a name="ln303">        }</a>
<a name="ln304">        else</a>
<a name="ln305">        {</a>
<a name="ln306">            err_code |= RD_ERROR_INVALID_DATA;</a>
<a name="ln307">        }</a>
<a name="ln308">    }</a>
<a name="ln309"> </a>
<a name="ln310">    if (RD_SUCCESS == err_code)</a>
<a name="ln311">    {</a>
<a name="ln312">        ri_watchdog_feed();</a>
<a name="ln313">    }</a>
<a name="ln314">}</a>
<a name="ln315"> </a>
<a name="ln316">#ifndef CEEDLING</a>
<a name="ln317">static</a>
<a name="ln318">#endif</a>
<a name="ln319">rd_status_t app_uart_isr (ri_comm_evt_t evt,</a>
<a name="ln320">                          void * p_data, size_t data_len)</a>
<a name="ln321">{</a>
<a name="ln322">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln323"> </a>
<a name="ln324">    switch (evt)</a>
<a name="ln325">    {</a>
<a name="ln326">        case RI_COMM_SENT:</a>
<a name="ln327">            break;</a>
<a name="ln328"> </a>
<a name="ln329">        case RI_COMM_RECEIVED:</a>
<a name="ln330">            err_code |= ri_scheduler_event_put (p_data, (uint16_t) data_len, app_uart_parser);</a>
<a name="ln331">            break;</a>
<a name="ln332"> </a>
<a name="ln333">        default:</a>
<a name="ln334">            // No action needed on connect/disconnect events.</a>
<a name="ln335">            break;</a>
<a name="ln336">    }</a>
<a name="ln337"> </a>
<a name="ln338">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln339">    return err_code;</a>
<a name="ln340">}</a>
<a name="ln341"> </a>
<a name="ln342">/** @brief convert baudrate from board definition for driver. */</a>
<a name="ln343">static ri_uart_baudrate_t rb_to_ri_baud (const uint32_t rb_baud)</a>
<a name="ln344">{</a>
<a name="ln345">    ri_uart_baudrate_t baud;</a>
<a name="ln346"> </a>
<a name="ln347">    switch (rb_baud)</a>
<a name="ln348">    {</a>
<a name="ln349">        case RB_UART_BAUDRATE_9600:</a>
<a name="ln350">            baud = RI_UART_BAUD_9600;</a>
<a name="ln351">            break;</a>
<a name="ln352"> </a>
<a name="ln353">        case RB_UART_BAUDRATE_115200:</a>
<a name="ln354">            baud = RI_UART_BAUD_115200;</a>
<a name="ln355">            break;</a>
<a name="ln356"> </a>
<a name="ln357">        default:</a>
<a name="ln358">            baud = RI_UART_BAUD_115200;</a>
<a name="ln359">            break;</a>
<a name="ln360">    }</a>
<a name="ln361"> </a>
<a name="ln362">    return baud;</a>
<a name="ln363">}</a>
<a name="ln364"> </a>
<a name="ln365">static void setup_uart_init (ri_uart_init_t * const p_init)</a>
<a name="ln366">{</a>
<a name="ln367">    // Ruuvi board pin definitions are compatible with</a>
<a name="ln368">    // Ruuvi driver pin definitions.</a>
<a name="ln369">#if APP_USBUART_ENABLED</a>
<a name="ln370">    p_init-&gt;hwfc_enabled = RB_UART_USB_HWFC_ENABLED;</a>
<a name="ln371">    p_init-&gt;parity_enabled = RB_UART_USB_PARITY_ENABLED;</a>
<a name="ln372">    p_init-&gt;cts = RB_UART_USB_CTS_PIN;</a>
<a name="ln373">    p_init-&gt;rts = RB_UART_USB_RTS_PIN;</a>
<a name="ln374">    p_init-&gt;tx = RB_UART_USB_TX_PIN;</a>
<a name="ln375">    p_init-&gt;rx = RB_UART_USB_RX_PIN;</a>
<a name="ln376">    p_init-&gt;baud = rb_to_ri_baud (RB_UART_BAUDRATE);</a>
<a name="ln377">#else</a>
<a name="ln378">    p_init-&gt;hwfc_enabled = RB_HWFC_ENABLED;</a>
<a name="ln379">    p_init-&gt;parity_enabled = RB_PARITY_ENABLED;</a>
<a name="ln380">    p_init-&gt;cts  = RB_UART_CTS_PIN;</a>
<a name="ln381">    p_init-&gt;rts  = RB_UART_RTS_PIN;</a>
<a name="ln382">    p_init-&gt;tx   = RB_UART_TX_PIN;</a>
<a name="ln383">    p_init-&gt;rx   = RB_UART_RX_PIN;</a>
<a name="ln384">    p_init-&gt;baud = rb_to_ri_baud (RB_UART_BAUDRATE);</a>
<a name="ln385">#endif</a>
<a name="ln386">}</a>
<a name="ln387"> </a>
<a name="ln388">rd_status_t app_uart_init (void)</a>
<a name="ln389">{</a>
<a name="ln390">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln391">    ri_uart_init_t config = { 0 };</a>
<a name="ln392">    setup_uart_init (&amp;config);</a>
<a name="ln393">    err_code |= ri_uart_init (&amp;m_uart);</a>
<a name="ln394"> </a>
<a name="ln395">    if (RD_SUCCESS == err_code)</a>
<a name="ln396">    {</a>
<a name="ln397">        m_uart.on_evt = app_uart_isr;</a>
<a name="ln398">        err_code |= ri_uart_config (&amp;config);</a>
<a name="ln399">    }</a>
<a name="ln400"> </a>
<a name="ln401">    return err_code;</a>
<a name="ln402">}</a>
<a name="ln403"> </a>
<a name="ln404">rd_status_t app_uart_send_broadcast (const ri_adv_scan_t * const scan)</a>
<a name="ln405">{</a>
<a name="ln406">    re_ca_uart_payload_t adv = {0};</a>
<a name="ln407">    ri_adv_scan_t m_scan = {0};</a>
<a name="ln408">    ri_comm_message_t msg = {0};</a>
<a name="ln409">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln410">    re_status_t re_code = RE_SUCCESS;</a>
<a name="ln411">    uint16_t manuf_id;</a>
<a name="ln412"> </a>
<a name="ln413">    if (NULL == scan)</a>
<a name="ln414">    {</a>
<a name="ln415">        err_code |= RD_ERROR_NULL;</a>
<a name="ln416">    }</a>
<a name="ln417">    else if (RE_CA_UART_ADV_BYTES &gt;= scan-&gt;data_len)</a>
<a name="ln418">    {</a>
<a name="ln419">        memcpy (adv.params.adv.mac, scan-&gt;addr, sizeof (adv.params.adv.mac));</a>
<a name="ln420">        memcpy (adv.params.adv.adv, scan-&gt;data, scan-&gt;data_len);</a>
<a name="ln421">        memcpy (m_scan.data, scan-&gt;data, scan-&gt;data_len);</a>
<a name="ln422">        memcpy (&amp;m_scan.data_len, &amp;scan-&gt;data_len, sizeof (size_t));</a>
<a name="ln423">        adv.params.adv.rssi_db = scan-&gt;rssi;</a>
<a name="ln424">        adv.params.adv.adv_len = scan-&gt;data_len;</a>
<a name="ln425">        adv.cmd = RE_CA_UART_ADV_RPRT;</a>
<a name="ln426">        msg.data_length = sizeof (msg);</a>
<a name="ln427">        re_code = re_ca_uart_encode (msg.data, &amp;msg.data_length, &amp;adv);</a>
<a name="ln428">        msg.repeat_count = 1;</a>
<a name="ln429">        manuf_id = ri_adv_parse_manuid (m_scan.data, m_scan.data_len);</a>
<a name="ln430"> </a>
<a name="ln431">        if (RE_SUCCESS == re_code)</a>
<a name="ln432">        {</a>
<a name="ln433">            if ((app_ble_manufacturer_filter_enabled())</a>
<a name="ln434">                    &amp;&amp; (manuf_id == RB_BLE_MANUFACTURER_ID))</a>
<a name="ln435">            {</a>
<a name="ln436">                err_code |= m_uart.send (&amp;msg);</a>
<a name="ln437">            }</a>
<a name="ln438">            else if ((!app_ble_manufacturer_filter_enabled()))</a>
<a name="ln439">            {</a>
<a name="ln440">                err_code |= m_uart.send (&amp;msg);</a>
<a name="ln441">            }</a>
<a name="ln442">            else</a>
<a name="ln443">            {</a>
<a name="ln444">                err_code |= RD_ERROR_INVALID_DATA;</a>
<a name="ln445">            }</a>
<a name="ln446">        }</a>
<a name="ln447">        else</a>
<a name="ln448">        {</a>
<a name="ln449">            err_code |= RD_ERROR_INVALID_DATA;</a>
<a name="ln450">        }</a>
<a name="ln451">    }</a>
<a name="ln452">    else</a>
<a name="ln453">    {</a>
<a name="ln454">        err_code |= RD_ERROR_DATA_SIZE;</a>
<a name="ln455">    }</a>
<a name="ln456"> </a>
<a name="ln457">    return err_code;</a>
<a name="ln458">}</a>
<a name="ln459"> </a>
<a name="ln460">rd_status_t app_uart_poll_configuration (void)</a>
<a name="ln461">{</a>
<a name="ln462">    re_ca_uart_payload_t cfg = {0};</a>
<a name="ln463">    ri_comm_message_t msg = {0};</a>
<a name="ln464">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln465">    re_status_t re_code = RE_SUCCESS;</a>
<a name="ln466">    msg.data_length = sizeof (msg);</a>
<a name="ln467">    cfg.cmd = RE_CA_UART_GET_ALL;</a>
<a name="ln468">    re_code = re_ca_uart_encode (msg.data, &amp;msg.data_length, &amp;cfg);</a>
<a name="ln469">    msg.repeat_count = RI_COMM_MSG_REPEAT_FOREVER;</a>
<a name="ln470"> </a>
<a name="ln471">    if (RE_SUCCESS == re_code)</a>
<a name="ln472">    {</a>
<a name="ln473">        err_code |= m_uart.send (&amp;msg);</a>
<a name="ln474"> </a>
<a name="ln475">        do</a>
<a name="ln476">        {</a>
<a name="ln477">            ri_scheduler_execute();</a>
<a name="ln478">            ri_yield();</a>
<a name="ln479">        } while (!m_uart_ack);</a>
<a name="ln480">    }</a>
<a name="ln481">    else</a>
<a name="ln482">    {</a>
<a name="ln483">        err_code |= RD_ERROR_INVALID_DATA;</a>
<a name="ln484">    }</a>
<a name="ln485"> </a>
<a name="ln486">    return err_code;</a>
<a name="ln487">}</a>
<a name="ln488"> </a>
<a name="ln489">/** @} */</a>

</code></pre>
<div class="balloon" rel="53"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="66"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2545/" target="_blank">V2545</a> Conversion between pointers to the 'unsigned int' type and the '_Bool' type should not be performed. Consider inspecting the expression: '(_Bool *) flag'.</p></div>
<div class="balloon" rel="66"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2567/" target="_blank">V2567</a> The cast should not remove 'volatile' qualification from the type that is pointed to by a pointer.</p></div>
<div class="balloon" rel="62"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2506/" target="_blank">V2506</a> A function should have a single point of exit at the end.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="102"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="102"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="108"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="108"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="114"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="114"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="137"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="145"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="145"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="148"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="148"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="151"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="151"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="194"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'sizeof (msg.data)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="199"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(uint8_t *) p_data'.</p></div>
<div class="balloon" rel="220"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(uint8_t *) p_data'.</p></div>
<div class="balloon" rel="220"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2562/" target="_blank">V2562</a> Expressions with pointer type should not be used in the '+', '-', '+=' and '-=' operations.</p></div>
<div class="balloon" rel="225"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="244"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="248"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2562/" target="_blank">V2562</a> Expressions with pointer type should not be used in the '+', '-', '+=' and '-=' operations.</p></div>
<div class="balloon" rel="271"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="275"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="280"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="289"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="320"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2009/" target="_blank">V2009</a> Consider rendering the 'p_data' pointer as a pointer to const.</p></div>
<div class="balloon" rel="378"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'unsigned'.</p></div>
<div class="balloon" rel="379"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'unsigned'.</p></div>
<div class="balloon" rel="380"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xFFFFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="381"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xFFFFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="382"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(((0U) << 8U) + (31U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="383"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(((0U) << 8U) + (11U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="424"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'scan->data_len' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="426"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'sizeof (msg)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="428"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="434"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="466"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'sizeof (msg)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
